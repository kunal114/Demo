import requests
import pandas as pd
import os
import time
from pathlib import Path

def download_csv(url, filename):
    response = requests.get(url)
    if response.status_code == 200:
        downloads_path = str(Path.home() / "Downloads")
        filepath = os.path.join(downloads_path, filename)
        with open(filepath, 'wb') as f:
            f.write(response.content)
        print(f"File downloaded: {filepath}")
        return filepath
    else:
        print(f"Failed to download file. Status code: {response.status_code}")
        return None

def copy_and_delete_file(source_path, dest_path):
    if os.path.exists(source_path):
        # Copy the file
        with open(source_path, 'rb') as src, open(dest_path, 'wb') as dst:
            dst.write(src.read())
        print(f"File copied to: {dest_path}")
        
        # Delete the original file
        os.remove(source_path)
        print(f"Original file deleted: {source_path}")
    else:
        print(f"Error: File {source_path} not found.")

def compare_dataframes(df1, df2):
    # Find rows in df1 but not in df2
    diff1_to_2 = pd.merge(df1, df2, how='outer', indicator=True).query('_merge == "left_only"').drop('_merge', axis=1)
    
    # Find rows in df2 but not in df1
    diff2_to_1 = pd.merge(df1, df2, how='outer', indicator=True).query('_merge == "right_only"').drop('_merge', axis=1)
    
    return diff1_to_2, diff2_to_1

def main():
    # URL for the CSV file
    url = 'https://data-insights.galacloud.joechase.net/extractor/query?gu36-00043be6-0773-4327-6351-45653chay'
    filename = "80043be6-8f72-4327-8351-45653cb07eed.csv"

    # Download the file
    downloaded_file = download_csv(url, filename)
    
    if downloaded_file:
        # Wait for the file to be fully written
        time.sleep(2)
        
        # Copy the file to the current directory and delete the original
        current_dir = os.getcwd()
        dest_path = os.path.join(current_dir, filename)
        copy_and_delete_file(downloaded_file, dest_path)
        
        # Read the CSV file
        df1 = pd.read_csv(dest_path)
        print("First CSV file preview:")
        print(df1.head())
        
        # For demonstration, we'll create a slightly modified version of df1 as df2
        # In a real scenario, you'd load your second CSV file here
        df2 = df1.copy()
        df2 = df2.iloc[1:] # Remove the first row to create a difference
        
        # Compare the dataframes
        diff1_to_2, diff2_to_1 = compare_dataframes(df1, df2)
        
        print("\nRows in first CSV but not in second CSV:")
        print(diff1_to_2)
        
        print("\nRows in second CSV but not in first CSV:")
        print(diff2_to_1)
        
        # Save the comparison results
        diff1_to_2.to_csv("diff1_to_2.csv", index=False)
        diff2_to_1.to_csv("diff2_to_1.csv", index=False)
        print("\nComparison results saved as diff1_to_2.csv and diff2_to_1.csv")

if __name__ == "__main__":
    main()
