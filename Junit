import streamlit as st
import pandas as pd
import webbrowser

def compare_dataframes(df1, df2):
    # Find rows in df1 but not in df2
    diff1_to_2 = pd.merge(df1, df2, how='outer', indicator=True).query('_merge == "left_only"').drop('_merge', axis=1)
    
    # Find rows in df2 but not in df1
    diff2_to_1 = pd.merge(df1, df2, how='outer', indicator=True).query('_merge == "right_only"').drop('_merge', axis=1)
    
    return diff1_to_2, diff2_to_1

def main():
    st.title("CSV Download and Comparison App")

    # URL for the CSV file
    url = 'https://data-insights.galacloud.joechase.net/extractor/query?gu36-00043be6-0773-4327-6351-45653chay'

    st.write(f"Step 1: Download the CSV file from the following URL:")
    st.write(url)

    if st.button("Open URL to download CSV"):
        webbrowser.open(url)
        st.success("URL opened in a new tab. Please download the CSV file.")

    st.write("Step 2: Upload the downloaded CSV file")
    uploaded_file = st.file_uploader("Choose the CSV file you just downloaded", type="csv")

    if uploaded_file is not None:
        df1 = pd.read_csv(uploaded_file)

        st.write("### CSV Preview")
        st.write(df1.head())

        st.write("Step 3: Upload a second CSV file to compare")
        file2 = st.file_uploader("Choose the second CSV file", type="csv")

        if file2 is not None:
            df2 = pd.read_csv(file2)

            st.write("### Second CSV Preview")
            st.write(df2.head())

            if st.button("Compare CSVs"):
                diff1_to_2, diff2_to_1 = compare_dataframes(df1, df2)

                st.write("### Rows in first CSV but not in second CSV")
                st.write(diff1_to_2)

                st.write("### Rows in second CSV but not in first CSV")
                st.write(diff2_to_1)

                # Option to download the comparison results
                if not diff1_to_2.empty:
                    csv1 = diff1_to_2.to_csv(index=False)
                    st.download_button(
                        label="Download rows unique to first CSV",
                        data=csv1,
                        file_name="diff1_to_2.csv",
                        mime="text/csv",
                    )

                if not diff2_to_1.empty:
                    csv2 = diff2_to_1.to_csv(index=False)
                    st.download_button(
                        label="Download rows unique to second CSV",
                        data=csv2,
                        file_name="diff2_to_1.csv",
                        mime="text/csv",
                    )

if __name__ == "__main__":
    main()
