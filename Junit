import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;

import javax.sql.DataSource;
import java.util.Properties;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class AwsRdsAuroraMySqlConfigurationLocalTest {

    private AwsRdsAuroraMySqlConfigurationLocal configurationLocal;

    @Mock
    private ConfigBase configBase;

    @BeforeEach
    void setUp() {
        configurationLocal = new AwsRdsAuroraMySqlConfigurationLocal(configBase);
    }

    @Test
    void testAwsRdsAuroraMySqlDataSource_WithDbAuthToken() {
        ReflectionTestUtils.setField(configurationLocal, "dbAuthToken", "testToken");

        DataSource dataSource = configurationLocal.awsRdsAuroraMySqlDataSource();
        assertNotNull(dataSource);

        Properties props = (Properties) ReflectionTestUtils.getField(dataSource, "connectionProperties");
        assertEquals("false", props.getProperty("PROP_AWS_IAM"));
        assertEquals("testToken", props.getProperty("password"));
    }

    @Test
    void testAwsRdsAuroraMySqlDataSource_WithoutDbAuthToken() {
        ReflectionTestUtils.setField(configurationLocal, "dbAuthToken", "na");

        DataSource dataSource = configurationLocal.awsRdsAuroraMySqlDataSource();
        assertNotNull(dataSource);

        Properties props = (Properties) ReflectionTestUtils.getField(dataSource, "connectionProperties");
        assertEquals("true", props.getProperty("PROP_AWS_IAM"));
    }

    @Nested
    class GetPropsForLocalTests {
        @Test
        void testGetPropsForLocal_WithDbAuthToken() {
            ReflectionTestUtils.setField(configurationLocal, "dbAuthToken", "testToken");
            when(configBase.getProps()).thenReturn(new Properties());

            Properties props = ReflectionTestUtils.invokeMethod(configurationLocal, "getPropsForLocal");
            assertNotNull(props);
            assertEquals("false", props.getProperty("PROP_AWS_IAM"));
            assertEquals("testToken", props.getProperty("password"));
        }

        @Test
        void testGetPropsForLocal_WithoutDbAuthToken() {
            ReflectionTestUtils.setField(configurationLocal, "dbAuthToken", "na");
            when(configBase.getProps()).thenReturn(new Properties());

            Properties props = ReflectionTestUtils.invokeMethod(configurationLocal, "getPropsForLocal");
            assertNotNull(props);
            assertEquals("true", props.getProperty("PROP_AWS_IAM"));
        }
    }
}
